# Customer Management Feature

## Tổng quan
Feature Customer Management cung cấp đầy đủ chức năng quản lý tài khoản khách hàng bao gồm đăng ký, đăng nhập với JWT authentication, quản lý thông tin cá nhân và địa chỉ giao hàng.

## Entities

### Customer (Enhanced)
```java
- id: Long (Primary Key)
- name: String (Required)
- email: String (Required, Unique)
- passwordHash: String (Required, BCrypt encoded)
- phone: String
- registeredDate: LocalDate
- addresses: List<Address> (OneToMany, cascade delete)
```

### Address (New)
```java
- id: Long (Primary Key)
- street: String (Required)
- city: String (Required)
- postalCode: String
- country: String (Required)
- customer: Customer (ManyToOne, Required)
```

## API Endpoints

### 1. POST /api/customers/register
**Mô tả**: Đăng ký tài khoản khách hàng mới

**Request Body**:
```json
{
  "name": "John Doe",
  "email": "john.doe@example.com",
  "password": "password123",
  "phone": "0901234567"
}
```

**Validation Rules**:
- `name`: Required, not blank
- `email`: Required, valid email format, must be unique
- `password`: Required, minimum 6 characters
- `phone`: Optional

**Response** (201 Created):
```json
{
  "id": 7,
  "name": "John Doe",
  "email": "john.doe@example.com",
  "phone": "0901234567",
  "registeredDate": "2025-10-20",
  "addresses": []
}
```

**Error Response** (400 - Email exists):
```json
{
  "timestamp": "2025-10-20T15:00:00.000+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "Email already registered: john.doe@example.com"
}
```

### 2. POST /api/customers/login
**Mô tả**: Đăng nhập và nhận JWT token

**Request Body**:
```json
{
  "email": "john.doe@example.com",
  "password": "password123"
}
```

**Response** (200 OK):
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "type": "Bearer",
  "customerId": 7,
  "name": "John Doe",
  "email": "john.doe@example.com"
}
```

**Error Response** (401 - Invalid credentials):
```json
{
  "timestamp": "2025-10-20T15:00:00.000+00:00",
  "status": 401,
  "error": "Unauthorized",
  "message": "Invalid email or password"
}
```

### 3. GET /api/customers/profile
**Mô tả**: Lấy thông tin profile của khách hàng hiện tại

**Authentication**: Required (JWT Bearer token)

**Headers**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response** (200 OK):
```json
{
  "id": 7,
  "name": "John Doe",
  "email": "john.doe@example.com",
  "phone": "0901234567",
  "registeredDate": "2025-10-20",
  "addresses": [
    {
      "id": 6,
      "street": "123 Main Street",
      "city": "Ho Chi Minh",
      "postalCode": "700000",
      "country": "Vietnam"
    }
  ]
}
```

**Error Response** (401 - No token or invalid token):
```json
{
  "timestamp": "2025-10-20T15:00:00.000+00:00",
  "status": 401,
  "error": "Unauthorized",
  "message": "Full authentication is required to access this resource"
}
```

### 4. PUT /api/customers/profile
**Mô tả**: Cập nhật thông tin profile (không thể thay đổi email)

**Authentication**: Required (JWT Bearer token)

**Request Body** (all fields optional):
```json
{
  "name": "John Smith",
  "phone": "0912345678"
}
```

**Response** (200 OK):
```json
{
  "id": 7,
  "name": "John Smith",
  "email": "john.doe@example.com",
  "phone": "0912345678",
  "registeredDate": "2025-10-20",
  "addresses": [...]
}
```

### 5. GET /api/customers/addresses
**Mô tả**: Lấy danh sách địa chỉ của khách hàng hiện tại

**Authentication**: Required (JWT Bearer token)

**Response** (200 OK):
```json
[
  {
    "id": 6,
    "street": "123 Main Street",
    "city": "Ho Chi Minh",
    "postalCode": "700000",
    "country": "Vietnam"
  },
  {
    "id": 7,
    "street": "456 Second Street",
    "city": "Hanoi",
    "postalCode": "100000",
    "country": "Vietnam"
  }
]
```

### 6. POST /api/customers/addresses
**Mô tả**: Thêm địa chỉ mới cho khách hàng hiện tại

**Authentication**: Required (JWT Bearer token)

**Request Body**:
```json
{
  "street": "789 Third Street",
  "city": "Da Nang",
  "postalCode": "550000",
  "country": "Vietnam"
}
```

**Validation Rules**:
- `street`: Required, not blank
- `city`: Required, not blank
- `postalCode`: Optional
- `country`: Required, not blank

**Response** (201 Created):
```json
{
  "id": 8,
  "street": "789 Third Street",
  "city": "Da Nang",
  "postalCode": "550000",
  "country": "Vietnam"
}
```

## Authentication Flow

### JWT Token
- **Algorithm**: HS256 (HMAC with SHA-256)
- **Expiration**: 24 hours (86400000 ms)
- **Token Structure**: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.payload.signature`

### Password Security
- **Hashing**: BCrypt
- **Salt**: Auto-generated by BCrypt
- **Strength**: 10 rounds (default)

### Authentication Process

1. **Registration**:
   ```
   Client → POST /api/customers/register
   Server → Hash password with BCrypt
   Server → Save customer to database
   Server → Return customer profile (without password)
   ```

2. **Login**:
   ```
   Client → POST /api/customers/login {email, password}
   Server → Find customer by email
   Server → Verify password with BCrypt
   Server → Generate JWT token
   Server → Return token + customer info
   ```

3. **Authenticated Request**:
   ```
   Client → GET /api/customers/profile
         → Header: Authorization: Bearer {token}
   Server → Extract token from header
   Server → Validate token signature
   Server → Extract email from token
   Server → Load customer from database
   Server → Return customer profile
   ```

## Features Chi Tiết

### ✅ Registration (Đăng ký)
- Validate email format và uniqueness
- Validate password strength (min 6 characters)
- Hash password với BCrypt
- Auto-set registered date
- Return profile without password

### ✅ Login (Đăng nhập)
- Validate credentials
- Generate JWT token với 24h expiration
- Return token + customer basic info
- Token contains: email, customerId, issued time, expiration

### ✅ Profile Management
- Get current customer profile
- Update name và phone (email không thể thay đổi)
- Include all addresses in profile response
- Authentication required (JWT)

### ✅ Address Management
- Get all addresses for current customer
- Add new address (multiple addresses supported)
- Cascade delete when customer is deleted
- Authentication required (JWT)

### ✅ Security Features
- Password hashing với BCrypt
- JWT token authentication
- Stateless sessions
- Token validation on every request
- Automatic expiration after 24 hours
- Protection against common attacks (SQL injection, XSS)

## Security Configuration

### Public Endpoints (No Authentication)
- `POST /api/customers/register`
- `POST /api/customers/login`
- `GET /api/products/**`
- `GET /api/categories/**`

### Protected Endpoints (JWT Required)
- `GET /api/customers/profile`
- `PUT /api/customers/profile`
- `GET /api/customers/addresses`
- `POST /api/customers/addresses`

### Admin Endpoints (Basic Auth Required)
- `GET /api/admin/**` (Uses HTTP Basic Auth with admin/admin123)

## Sample Data

### Customers (6 customers)
| ID | Name | Email | Phone | Password |
|----|------|-------|-------|----------|
| 1 | Nguyen Van A | nguyenvana@example.com | 0901234567 | password123 |
| 2 | Tran Thi B | tranthib@example.com | 0902345678 | password123 |
| 3 | Le Van C | levanc@example.com | 0903456789 | password123 |
| 4 | Pham Thi D | phamthid@example.com | 0904567890 | password123 |
| 5 | Hoang Van E | hoangvane@example.com | 0905678901 | password123 |
| 6 | Vu Thi F | vuthif@example.com | 0906789012 | password123 |

### Addresses (5 addresses)
- Customer 1 (Nguyen Van A): 2 addresses in Ho Chi Minh
- Customer 2 (Tran Thi B): 1 address in Hanoi
- Customer 3 (Le Van C): 1 address in Da Nang
- Customer 4 (Pham Thi D): 1 address in Hanoi

## Testing Guide

### 1. Register New Customer
```bash
curl -X POST http://localhost:8080/api/customers/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "email": "test@example.com",
    "password": "password123",
    "phone": "0909999999"
  }'
```

### 2. Login
```bash
curl -X POST http://localhost:8080/api/customers/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123"
  }'
```

**Save the token from response!**

### 3. Get Profile (with JWT token)
```bash
TOKEN="your-jwt-token-here"

curl http://localhost:8080/api/customers/profile \
  -H "Authorization: Bearer $TOKEN"
```

### 4. Update Profile
```bash
curl -X PUT http://localhost:8080/api/customers/profile \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "name": "Updated Name",
    "phone": "0911111111"
  }'
```

### 5. Get Addresses
```bash
curl http://localhost:8080/api/customers/addresses \
  -H "Authorization: Bearer $TOKEN"
```

### 6. Add New Address
```bash
curl -X POST http://localhost:8080/api/customers/addresses \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "street": "123 New Street",
    "city": "Can Tho",
    "postalCode": "900000",
    "country": "Vietnam"
  }'
```

### 7. Login with Sample Customer
```bash
curl -X POST http://localhost:8080/api/customers/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "nguyenvana@example.com",
    "password": "password123"
  }'
```

## Database Schema

### customers Table (Enhanced)
```sql
CREATE TABLE customers (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,      ← Unique constraint
    password_hash VARCHAR(255) NOT NULL,      ← BCrypt hash
    phone VARCHAR(50),
    registered_date DATE
);
```

### addresses Table (New)
```sql
CREATE TABLE addresses (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    street VARCHAR(255) NOT NULL,
    city VARCHAR(255) NOT NULL,
    postal_code VARCHAR(20),
    country VARCHAR(100) NOT NULL,
    customer_id BIGINT NOT NULL,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE
);
```

## DTOs

### RegisterRequest
```java
{
  @NotBlank String name;
  @NotBlank @Email String email;
  @NotBlank @Size(min=6) String password;
  String phone;
}
```

### LoginRequest
```java
{
  @NotBlank @Email String email;
  @NotBlank String password;
}
```

### LoginResponse
```java
{
  String token;
  String type = "Bearer";
  Long customerId;
  String name;
  String email;
}
```

### CustomerProfileDto
```java
{
  Long id;
  String name;
  String email;
  String phone;
  LocalDate registeredDate;
  List<AddressDto> addresses;
}
```

### UpdateProfileRequest
```java
{
  String name;
  String phone;
}
```

### CreateAddressRequest
```java
{
  @NotBlank String street;
  @NotBlank String city;
  String postalCode;
  @NotBlank String country;
}
```

### AddressDto
```java
{
  Long id;
  String street;
  String city;
  String postalCode;
  String country;
}
```

## Architecture

```
┌─────────────────────────────────────┐
│      CustomerController             │
│  - POST /register                   │
│  - POST /login                      │
│  - GET /profile (JWT)               │
│  - PUT /profile (JWT)               │
│  - GET /addresses (JWT)             │
│  - POST /addresses (JWT)            │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│      CustomerServiceImpl            │
│  - register() → BCrypt hash         │
│  - login() → JWT generation         │
│  - getProfile()                     │
│  - updateProfile()                  │
│  - getAddresses()                   │
│  - addAddress()                     │
└──────────────┬──────────────────────┘
               │
     ┌─────────┼─────────┐
     ▼         ▼         ▼
┌─────────┐ ┌─────────┐ ┌────────┐
│Customer │ │Address  │ │JwtUtil │
│Repo     │ │Repo     │ │        │
└─────────┘ └─────────┘ └────────┘

┌─────────────────────────────────────┐
│   JwtAuthenticationFilter           │
│  - Extract JWT from header          │
│  - Validate token                   │
│  - Set SecurityContext              │
└─────────────────────────────────────┘
```

## Error Handling

### 400 Bad Request
- Validation errors (email format, password length)
- Email already registered
- Missing required fields

### 401 Unauthorized
- Invalid credentials (login)
- Missing JWT token
- Expired JWT token
- Invalid JWT token

### 404 Not Found
- Customer not found

### 500 Internal Server Error
- Database errors
- Unexpected exceptions

## Configuration

### application.properties
```properties
# JWT Configuration
jwt.secret=mySecretKeyForJWTTokenGenerationThatIsAtLeast32BytesLong1234567890
jwt.expiration=86400000  # 24 hours in milliseconds
```

## Notes

- ✅ Full customer registration and login
- ✅ JWT authentication (24h expiration)
- ✅ BCrypt password hashing
- ✅ Profile management (view and update)
- ✅ Multiple addresses per customer
- ✅ Stateless authentication
- ✅ Secure password storage (never return password in response)
- ✅ Email uniqueness validation
- ✅ Cascade delete addresses when customer deleted
- ✅ Comprehensive error handling

## Future Enhancements

- [ ] Email verification
- [ ] Password reset functionality
- [ ] Refresh tokens
- [ ] OAuth2 integration (Google, Facebook login)
- [ ] Two-factor authentication (2FA)
- [ ] Account deactivation/deletion
- [ ] Update email functionality
- [ ] Change password functionality
- [ ] Address update and delete
- [ ] Set default address
- [ ] Order history in profile
- [ ] Customer preferences and settings
