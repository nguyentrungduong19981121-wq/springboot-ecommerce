# Category Management Feature

## T·ªïng quan
Feature Category Management cung c·∫•p ƒë·∫ßy ƒë·ªß CRUD operations cho danh m·ª•c s·∫£n ph·∫©m v·ªõi kh·∫£ nƒÉng t·ªï ch·ª©c theo c·∫•u tr√∫c ph√¢n c·∫•p (hierarchical/tree structure), SEO slug, v√† t·ª± ƒë·ªông x√≥a cascade khi x√≥a danh m·ª•c cha.

## Entities

### Category (Enhanced)
```java
- id: Long (Primary Key)
- name: String (Required)
- slug: String (Required, Unique)
- description: String (TEXT)
- parent: Category (ManyToOne, self-reference)
- children: List<Category> (OneToMany, cascade delete)
```

**ƒê·∫∑c ƒëi·ªÉm:**
- Self-referencing relationship (t·ª± tham chi·∫øu)
- Cascade delete: Khi x√≥a cha ‚Üí t·ª± ƒë·ªông x√≥a t·∫•t c·∫£ con
- Orphan removal: Khi remove child ‚Üí t·ª± ƒë·ªông x√≥a kh·ªèi database
- C√≥ th·ªÉ l·ªìng nhau nhi·ªÅu c·∫•p (unlimited depth)

## API Endpoints

### 1. GET /api/categories
**M√¥ t·∫£**: L·∫•y danh s√°ch categories (flat list ho·∫∑c hierarchical tree)

**Parameters**:
- `tree` (boolean, optional, default: false): 
  - `false`: Tr·∫£ v·ªÅ flat list (t·∫•t c·∫£ categories)
  - `true`: Tr·∫£ v·ªÅ hierarchical tree (ch·ªâ root categories v·ªõi children l·ªìng nhau)

**Example Requests**:
```bash
# Get flat list (all categories)
GET /api/categories

# Get hierarchical tree
GET /api/categories?tree=true
```

**Response (Flat List)**:
```json
[
  {
    "id": 1,
    "name": "Electronics",
    "slug": "electronics",
    "description": "All electronic devices",
    "parentId": null,
    "parentName": null,
    "children": null,
    "productCount": 0
  },
  {
    "id": 3,
    "name": "Laptops",
    "slug": "laptops",
    "description": "High-performance laptops",
    "parentId": 1,
    "parentName": "Electronics",
    "children": null,
    "productCount": 2
  }
]
```

**Response (Hierarchical Tree)**:
```json
[
  {
    "id": 1,
    "name": "Electronics",
    "slug": "electronics",
    "description": "All electronic devices",
    "parentId": null,
    "parentName": null,
    "productCount": 0,
    "children": [
      {
        "id": 3,
        "name": "Laptops",
        "slug": "laptops",
        "description": "High-performance laptops",
        "parentId": 1,
        "parentName": "Electronics",
        "productCount": 2,
        "children": [
          {
            "id": 6,
            "name": "Gaming Laptops",
            "slug": "gaming-laptops",
            "description": "Gaming laptops",
            "parentId": 3,
            "parentName": "Laptops",
            "productCount": 1,
            "children": []
          }
        ]
      }
    ]
  }
]
```

### 2. GET /api/categories/{id}
**M√¥ t·∫£**: L·∫•y th√¥ng tin chi ti·∫øt c·ªßa m·ªôt category v·ªõi children l·ªìng nhau

**Path Parameter**:
- `id` (Long): Category ID

**Example Request**:
```bash
GET /api/categories/1
```

**Response**:
```json
{
  "id": 1,
  "name": "Electronics",
  "slug": "electronics",
  "description": "All electronic devices and gadgets",
  "parentId": null,
  "parentName": null,
  "productCount": 0,
  "children": [
    {
      "id": 3,
      "name": "Laptops",
      "slug": "laptops",
      "parentId": 1,
      "productCount": 4,
      "children": [...]
    }
  ]
}
```

### 3. GET /api/categories/slug/{slug}
**M√¥ t·∫£**: L·∫•y category theo slug (SEO-friendly URL)

**Path Parameter**:
- `slug` (String): Category slug

**Example Request**:
```bash
GET /api/categories/slug/electronics
```

**Response**: Same as GET by ID

### 4. GET /api/categories/{id}/children
**M√¥ t·∫£**: L·∫•y danh s√°ch children tr·ª±c ti·∫øp c·ªßa m·ªôt category (kh√¥ng bao g·ªìm grandchildren)

**Path Parameter**:
- `id` (Long): Parent category ID

**Example Request**:
```bash
GET /api/categories/1/children
```

**Response**:
```json
[
  {
    "id": 3,
    "name": "Laptops",
    "slug": "laptops",
    "parentId": 1,
    "parentName": "Electronics",
    "children": null,
    "productCount": 4
  },
  {
    "id": 4,
    "name": "Smartphones",
    "slug": "smartphones",
    "parentId": 1,
    "parentName": "Electronics",
    "children": null,
    "productCount": 2
  }
]
```

### 5. POST /api/categories
**M√¥ t·∫£**: T·∫°o category m·ªõi

**Request Body**:
```json
{
  "name": "Gaming Accessories",
  "slug": "gaming-accessories",
  "description": "Accessories for gaming",
  "parentId": 2
}
```

**Validation Rules**:
- `name`: Required, not blank
- `slug`: Required, not blank, must be unique
- `description`: Optional
- `parentId`: Optional (null = root category, must exist if provided)

**Response** (201 Created):
```json
{
  "id": 11,
  "name": "Gaming Accessories",
  "slug": "gaming-accessories",
  "description": "Accessories for gaming",
  "parentId": 2,
  "parentName": "Accessories",
  "children": [],
  "productCount": 0
}
```

**Error Response** (400 - Duplicate slug):
```json
{
  "timestamp": "2025-10-20T12:00:00.000+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "Category with slug 'gaming-accessories' already exists"
}
```

### 6. PUT /api/categories/{id}
**M√¥ t·∫£**: C·∫≠p nh·∫≠t category (partial update)

**Path Parameter**:
- `id` (Long): Category ID

**Request Body** (all fields optional):
```json
{
  "name": "Updated Name",
  "slug": "updated-slug",
  "description": "Updated description",
  "parentId": 5
}
```

**Validation Rules**:
- Slug must be unique if changed
- Cannot set self as parent
- Cannot set a descendant as parent (prevents circular reference)
- Parent must exist if provided

**Response** (200 OK):
```json
{
  "id": 3,
  "name": "Updated Name",
  "slug": "updated-slug",
  "description": "Updated description",
  "parentId": 5,
  "parentName": "Tablets",
  "children": [],
  "productCount": 0
}
```

**Error Response** (400 - Circular reference):
```json
{
  "timestamp": "2025-10-20T12:00:00.000+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "Cannot set a descendant category as parent (circular reference)"
}
```

### 7. DELETE /api/categories/{id}
**M√¥ t·∫£**: X√≥a category v√† t·∫•t c·∫£ children (cascade delete)

**Path Parameter**:
- `id` (Long): Category ID

**Example Request**:
```bash
DELETE /api/categories/1
```

**Response** (204 No Content):
```
(empty body)
```

**Notes**:
- Cascade delete: X√≥a category cha s·∫Ω t·ª± ƒë·ªông x√≥a t·∫•t c·∫£ children v√† grandchildren
- Products thu·ªôc category b·ªã x√≥a s·∫Ω c√≥ `categoryId = null`

## Features Chi Ti·∫øt

### üå≥ Hierarchical Structure (C·∫•u tr√∫c ph√¢n c·∫•p)
- Category c√≥ th·ªÉ c√≥ parent (danh m·ª•c cha)
- Category c√≥ th·ªÉ c√≥ nhi·ªÅu children (danh m·ª•c con)
- Kh√¥ng gi·ªõi h·∫°n ƒë·ªô s√¢u (unlimited depth)
- Example hierarchy:
  ```
  Electronics (root)
  ‚îú‚îÄ‚îÄ Laptops
  ‚îÇ   ‚îú‚îÄ‚îÄ Gaming Laptops
  ‚îÇ   ‚îú‚îÄ‚îÄ Business Laptops
  ‚îÇ   ‚îî‚îÄ‚îÄ Ultrabooks
  ‚îú‚îÄ‚îÄ Smartphones
  ‚îî‚îÄ‚îÄ Tablets
  Accessories (root)
  ‚îú‚îÄ‚îÄ Phone Accessories
  ‚îî‚îÄ‚îÄ Laptop Accessories
  ```

### üîó Self-Referencing Relationship
- ManyToOne: `parent` - Reference ƒë·∫øn category cha
- OneToMany: `children` - Collection c√°c category con
- Cascade delete: `CascadeType.ALL` + `orphanRemoval = true`

### ‚úÖ Validation

#### Unique Slug
- M·ªói category ph·∫£i c√≥ slug duy nh·∫•t
- Validate khi CREATE
- Validate khi UPDATE (n·∫øu thay ƒë·ªïi slug)
- Error message: "Category with slug 'xxx' already exists"

#### Prevent Self-Parent
- Category kh√¥ng th·ªÉ l√† parent c·ªßa ch√≠nh n√≥
- Error: "Category cannot be its own parent"

#### Prevent Circular Reference
- Category kh√¥ng th·ªÉ set m·ªôt descendant (con/ch√°u) l√†m parent
- Example: N·∫øu A l√† cha c·ªßa B, v√† B l√† cha c·ªßa C, th√¨ C kh√¥ng th·ªÉ set A ho·∫∑c B l√†m parent
- Error: "Cannot set a descendant category as parent (circular reference)"

#### Parent Existence
- Parent category ph·∫£i t·ªìn t·∫°i n·∫øu cung c·∫•p parentId
- Error: "Parent category not found with id: xxx"

### üóëÔ∏è Cascade Delete
- Khi x√≥a category cha ‚Üí t·ª± ƒë·ªông x√≥a t·∫•t c·∫£ children
- Khi x√≥a category ‚Üí t·ª± ƒë·ªông x√≥a t·∫•t c·∫£ descendants (con, ch√°u, ch·∫Øt...)
- JPA handles cascade with `CascadeType.ALL` v√† `orphanRemoval = true`
- Products trong category b·ªã x√≥a kh√¥ng b·ªã x√≥a (ch·ªâ set `categoryId = null`)

### üìä Product Count
- M·ªói category response bao g·ªìm s·ªë l∆∞·ª£ng products
- Count ƒë∆∞·ª£c t√≠nh real-time t·ª´ database
- Ch·ªâ count products tr·ª±c ti·∫øp trong category ƒë√≥ (kh√¥ng bao g·ªìm subcategories)

### üîç SEO Slug
- M·ªói category c√≥ slug duy nh·∫•t
- Slug d√πng cho SEO-friendly URLs
- C√≥ th·ªÉ query category theo slug: `GET /api/categories/slug/{slug}`

## Database Schema

### categories Table
```sql
CREATE TABLE categories (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) NOT NULL UNIQUE,
    description TEXT,
    parent_id BIGINT,
    FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE CASCADE
);
```

**Indexes**:
- Primary key: `id`
- Unique: `slug`
- Foreign key: `parent_id` (self-reference)

## Sample Data

### Hierarchical Category Structure

```
Electronics (id=1, root)
‚îú‚îÄ‚îÄ Laptops (id=3)
‚îÇ   ‚îú‚îÄ‚îÄ Gaming Laptops (id=6)
‚îÇ   ‚îú‚îÄ‚îÄ Business Laptops (id=7)
‚îÇ   ‚îî‚îÄ‚îÄ Ultrabooks (id=8)
‚îú‚îÄ‚îÄ Smartphones (id=4)
‚îî‚îÄ‚îÄ Tablets (id=5)

Accessories (id=2, root)
‚îú‚îÄ‚îÄ Phone Accessories (id=9)
‚îî‚îÄ‚îÄ Laptop Accessories (id=10)
```

### Products Assignment
- Laptop Dell XPS 13 ‚Üí Ultrabooks (id=8)
- iPhone 13 Pro ‚Üí Smartphones (id=4)
- Samsung Galaxy S21 ‚Üí Smartphones (id=4)
- MacBook Pro 14 ‚Üí Business Laptops (id=7)
- iPad Air ‚Üí Tablets (id=5)
- ASUS ROG Strix ‚Üí Gaming Laptops (id=6)
- AirPods Pro ‚Üí Phone Accessories (id=9)

## Testing Guide

### 1. Get All Categories (Flat List)
```bash
curl http://localhost:8080/api/categories
```

### 2. Get Category Tree
```bash
curl http://localhost:8080/api/categories?tree=true
```

### 3. Get Single Category
```bash
curl http://localhost:8080/api/categories/1
```

### 4. Get Category by Slug
```bash
curl http://localhost:8080/api/categories/slug/electronics
```

### 5. Get Children
```bash
curl http://localhost:8080/api/categories/1/children
```

### 6. Create Root Category
```bash
curl -X POST http://localhost:8080/api/categories \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Home Appliances",
    "slug": "home-appliances",
    "description": "Appliances for home"
  }'
```

### 7. Create Child Category
```bash
curl -X POST http://localhost:8080/api/categories \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Kitchen Appliances",
    "slug": "kitchen-appliances",
    "description": "Appliances for kitchen",
    "parentId": 11
  }'
```

### 8. Update Category
```bash
curl -X PUT http://localhost:8080/api/categories/3 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Notebooks",
    "description": "Updated description"
  }'
```

### 9. Move Category to Different Parent
```bash
curl -X PUT http://localhost:8080/api/categories/6 \
  -H "Content-Type: application/json" \
  -d '{
    "parentId": 5
  }'
```

### 10. Delete Category (Cascade)
```bash
# This will delete category 3 and all its children (6, 7, 8)
curl -X DELETE http://localhost:8080/api/categories/3
```

### 11. Test Unique Slug Validation
```bash
curl -X POST http://localhost:8080/api/categories \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Another Electronics",
    "slug": "electronics"
  }'
# Expected: 400 Bad Request
```

### 12. Test Circular Reference Prevention
```bash
# Try to set child as parent of its parent
curl -X PUT http://localhost:8080/api/categories/1 \
  -H "Content-Type: application/json" \
  -d '{
    "parentId": 3
  }'
# Expected: 400 Bad Request (circular reference)
```

## DTOs

### CategoryDto (Response)
```java
{
  Long id;
  String name;
  String slug;
  String description;
  Long parentId;
  String parentName;
  List<CategoryDto> children;  // Nested children (null for flat list)
  Integer productCount;
}
```

### CreateCategoryRequest
```java
{
  @NotBlank String name;
  @NotBlank String slug;
  String description;
  Long parentId;  // null = root category
}
```

### UpdateCategoryRequest
```java
{
  String name;
  String slug;
  String description;
  Long parentId;
}
```

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      CategoryController             ‚îÇ
‚îÇ  - GET /api/categories              ‚îÇ
‚îÇ  - GET /api/categories/{id}         ‚îÇ
‚îÇ  - GET /api/categories/slug/{slug}  ‚îÇ
‚îÇ  - GET /api/categories/{id}/children‚îÇ
‚îÇ  - POST /api/categories             ‚îÇ
‚îÇ  - PUT /api/categories/{id}         ‚îÇ
‚îÇ  - DELETE /api/categories/{id}      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      CategoryServiceImpl            ‚îÇ
‚îÇ  - CRUD operations                  ‚îÇ
‚îÇ  - Hierarchy building               ‚îÇ
‚îÇ  - Slug validation                  ‚îÇ
‚îÇ  - Circular reference prevention    ‚îÇ
‚îÇ  - DTO conversion                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      CategoryRepository             ‚îÇ
‚îÇ  - findBySlug()                     ‚îÇ
‚îÇ  - existsBySlug()                   ‚îÇ
‚îÇ  - findRootCategories()             ‚îÇ
‚îÇ  - findByParentId()                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ   H2 DB   ‚îÇ
         ‚îÇ categories‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Error Handling

### 404 Not Found
- Category kh√¥ng t·ªìn t·∫°i (by ID or slug)
- Parent category kh√¥ng t·ªìn t·∫°i

### 400 Bad Request
- Validation errors (missing required fields)
- Duplicate slug
- Self-parent attempt
- Circular reference
- Invalid data format

### 500 Internal Server Error
- Database errors
- Unexpected exceptions

## Notes

- ‚úÖ Full CRUD operations
- ‚úÖ Hierarchical parent-child structure
- ‚úÖ Unlimited nesting depth
- ‚úÖ Cascade delete (auto-delete children)
- ‚úÖ Unique slug validation
- ‚úÖ SEO-friendly slugs
- ‚úÖ Circular reference prevention
- ‚úÖ Product count per category
- ‚úÖ Flat list v√† tree view
- ‚úÖ Comprehensive validation
- ‚úÖ DTO pattern for clean API

## Future Enhancements

- [ ] Breadcrumb generation (path from root to current)
- [ ] Category reordering (sort order)
- [ ] Category image/icon
- [ ] Category visibility toggle
- [ ] Featured categories
- [ ] Category metadata for SEO
- [ ] Bulk operations
- [ ] Category merge functionality
- [ ] Category move with drag-and-drop
- [ ] Category statistics dashboard
